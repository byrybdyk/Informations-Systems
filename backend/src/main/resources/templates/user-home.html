<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Home</title>

    <!-- Подключение скриптов SockJS и STOMP до вашего собственного кода -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <style>
        /* Ограничение размера контейнера для таблицы и добавление прокрутки */
        .table-container {
            width: 100%;
            max-height: 400px; /* Ограничение по высоте */
            overflow: auto; /* Прокрутка по горизонтали и вертикали */
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }

        th {
            background-color: #f2f2f2;
        }

        /* Стили для модального окна */
        .modal {
            display: none; /* Скрыто по умолчанию */
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>

    <script>
        var stompClient = null;

        // Создаем подключение к WebSocket
        function connect() {
            var socket = new SockJS('/ws');  // Адрес WebSocket сервера
            stompClient = Stomp.over(socket);

            // Подключаемся без заголовка Authorization
            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);

                stompClient.subscribe('/topic/labworks', function (message) {
                    var labWork = JSON.parse(message.body);
                    onLabWorkUpdate(labWork);  // Обрабатываем обновление
                });

            }, function (error) {
                console.error('WebSocket connection failed: ' + error);
                alert("WebSocket connection failed. Please try again.");
            });
        }

        // Функция для обработки обновлений LabWork
        function onLabWorkUpdate(labWork) {
            console.log('LabWork updated:', labWork);

            // Находим таблицу по ID
            var table = document.getElementById("labWorkTable");
            var rows = table.getElementsByTagName("tr");
            var rowUpdated = false;

            // Перебираем все строки в таблице, чтобы найти строку с таким же ID
            for (var i = 1; i < rows.length; i++) { // Начинаем с 1, чтобы пропустить заголовок
                var row = rows[i];
                var cell = row.cells[0];  // Предполагаем, что ID в первой ячейке

                if (cell && cell.innerHTML == labWork.id) {
                    // Если строка с таким ID уже существует, обновляем её
                    row.cells[1].innerHTML = labWork.ownerName;
                    row.cells[2].innerHTML = labWork.creationDate;
                    row.cells[3].innerHTML = labWork.name;
                    row.cells[4].innerHTML = labWork.disciplineName;
                    row.cells[5].innerHTML = labWork.practiceHours;
                    row.cells[6].innerHTML = labWork.description;
                    row.cells[7].innerHTML = labWork.difficulty;
                    row.cells[8].innerHTML = labWork.coordinates.x;
                    row.cells[9].innerHTML = labWork.coordinates.y;
                    row.cells[10].innerHTML = labWork.minimalPoint;
                    row.cells[11].innerHTML = labWork.personalQualitiesMax;
                    row.cells[12].innerHTML = labWork.personalQualitiesMin;
                    row.cells[13].innerHTML = labWork.authorName;
                    row.cells[14].innerHTML = labWork.authorWeight;
                    row.cells[15].innerHTML = labWork.authorEyeColor;
                    row.cells[16].innerHTML = labWork.authorHairColor;
                    row.cells[17].innerHTML = labWork.authorLocation.x;
                    row.cells[18].innerHTML = labWork.authorLocation.y;
                    row.cells[19].innerHTML = labWork.authorLocation.name;
                    row.cells[20].innerHTML = labWork.authorPassportID;
                    rowUpdated = true;
                    break;  // Строка найдена, выходим из цикла
                }
            }

            // Если строка с таким ID не найдена, добавляем новую
            if (!rowUpdated) {
                var newRow = table.insertRow();
                newRow.insertCell(0).innerHTML = labWork.id;
                newRow.insertCell(1).innerHTML = labWork.owner_id.username;
                newRow.insertCell(2).innerHTML = formatUTCDate(labWork.creationDate);
                newRow.insertCell(3).innerHTML = labWork.name;
                newRow.insertCell(4).innerHTML = labWork.discipline.name;
                newRow.insertCell(5).innerHTML = labWork.discipline.practiceHours;
                newRow.insertCell(6).innerHTML = labWork.description;
                newRow.insertCell(7).innerHTML = labWork.difficulty;
                newRow.insertCell(8).innerHTML = labWork.coordinates.x;
                newRow.insertCell(9).innerHTML = labWork.coordinates.y;
                newRow.insertCell(10).innerHTML = labWork.minimalPoint;
                newRow.insertCell(11).innerHTML = labWork.personalQualitiesMaximum;
                newRow.insertCell(12).innerHTML = labWork.personalQualitiesMinimum;
                newRow.insertCell(13).innerHTML = labWork.author.name;
                newRow.insertCell(14).innerHTML = labWork.author.weight;
                newRow.insertCell(15).innerHTML = labWork.author.eyeColor;
                newRow.insertCell(16).innerHTML = labWork.author.hairColor;
                newRow.insertCell(17).innerHTML = labWork.author.location.x;
                newRow.insertCell(18).innerHTML = labWork.author.location.y;
                newRow.insertCell(19).innerHTML = labWork.author.location.name;
                newRow.insertCell(20).innerHTML = labWork.author.passportID;
                newRow.insertCell(21).innerHTML = '<button onclick="editLabWork(' + labWork.id + ')">Edit</button>';
            }

        }

        async function addLabWork(event) {
            event.preventDefault(); // Остановить стандартное поведение формы

            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());

            // Создаем вложенные объекты для DTO
            const labWorkDTO = {
                name: data.name,
                description: data.description,
                difficulty: data.difficulty,
                coordinates: {
                    x: parseFloat(data.coordinatesX),
                    y: parseFloat(data.coordinatesY),
                },
                discipline: {
                    name: data.disciplineName,
                    practiceHours: parseInt(data.practiceHours),
                },
                author: {
                    name: data.authorName,
                    weight: parseFloat(data.authorWeight),
                    eyeColor: data.authorEyeColor,
                    hairColor: data.authorHairColor,
                    passportID: data.passportID,
                    location: {
                        x: parseFloat(data.locationX),
                        y: parseFloat(data.locationY),
                        name: data.locationName,
                    },
                },
                minimalPoint: parseFloat(data.minimalPoint),
                personalQualitiesMinimum: parseFloat(data.personalQualitiesMinimum),
                personalQualitiesMaximum: parseFloat(data.personalQualitiesMaximum),
                ownerId: parseInt(data.owner_id),
                ownerName: document.getElementById("userName").textContent
            };

            // Отправка данных на сервер через WebSocket
            stompClient.send("/app/labworks", {}, JSON.stringify(labWorkDTO)); // WebSocket запрос
        }

        window.onload = function() {
            connect();
        };

        function formatUTCDate(dateString) {
            let date = new Date(dateString); // Создаем объект Date из строки ISO

            // Форматируем дату в формат: yyyy-MM-dd HH:mm:ss.SSS
            let formattedDate = date.getUTCFullYear() + "-" +
                ("0" + (date.getUTCMonth() + 1)).slice(-2) + "-" +
                ("0" + date.getUTCDate()).slice(-2) + " " +
                ("0" + date.getUTCHours()).slice(-2) + ":" +
                ("0" + date.getUTCMinutes()).slice(-2) + ":" +
                ("0" + date.getUTCSeconds()).slice(-2) + "." +
                ("00" + date.getUTCMilliseconds()).slice(-3);

            return formattedDate; // Возвращаем отформатированную строку
        }
    </script>


</head>

<body>
<h1>Welcome, <span th:text="${username}" id="userName">User</span>!</h1>
<p>This is the user area.</p>

<h2>Add Lab Work</h2>
<form id="addLabWorkForm" onsubmit="addLabWork(event)">
    <input type="text" name="name" placeholder="Lab Work Name" required>
    <input type="text" name="disciplineName" placeholder="Discipline Name" required>
    <input type="number" name="practiceHours" placeholder="Practice Hours" required>
    <input type="text" name="description" placeholder="Description" required>
    <input type="text" name="difficulty" placeholder="Difficulty" required>
    <input type="number" name="coordinatesX" placeholder="Coordinates X" required>
    <input type="number" name="coordinatesY" placeholder="Coordinates Y" required>
    <input type="number" name="minimalPoint" placeholder="Minimal Point" required>
    <input type="number" name="personalQualitiesMaximum" placeholder="Personal Qualities Max" required>
    <input type="number" name="personalQualitiesMinimum" placeholder="Personal Qualities Min" required>
    <input type="text" name="authorName" placeholder="Author Name" required>
    <input type="number" name="authorWeight" placeholder="Author Weight" required>
    <input type="text" name="authorEyeColor" placeholder="Author Eye Color" required>
    <input type="text" name="authorHairColor" placeholder="Author Hair Color" required>
    <input type="number" name="locationX" placeholder="Location X" required>
    <input type="number" name="locationY" placeholder="Location Y" required>
    <input type="text" name="locationName" placeholder="Location Name" required>
    <input type="text" name="passportID" placeholder="Passport ID" required>
    <button type="submit">Add Lab Work</button>
</form>

<h2>LabWork Entities</h2>
<div class="table-container">
    <table id="labWorkTable">
        <thead>
        <tr>
            <th>ID</th>
            <th>Owner</th>
            <th>Creation Date</th>
            <th>Name</th>
            <th>Discipline Name</th>
            <th>Practice Hours</th>
            <th>Description</th>
            <th>Difficulty</th>
            <th>Coordinates X</th>
            <th>Coordinates Y</th>
            <th>Minimal Point</th>
            <th>Personal Qualities Max</th>
            <th>Personal Qualities Min</th>
            <th>Author Name</th>
            <th>Author Weight</th>
            <th>Author Eye Color</th>
            <th>Author Hair Color</th>
            <th>Location X</th>
            <th>Location Y</th>
            <th>Location Name</th>
            <th>Passport ID</th>
            <th>Actions</th> <!-- Добавлено поле для действий -->
        </tr>
        </thead>
        <tbody>
        <tr th:each="labWork : ${labWorks}">
            <td th:text="${labWork.id}"></td>
            <td th:text="${labWork.owner_id.getUsername()}"></td>
            <td th:text="${labWork.creationDate}"></td>
            <td th:text="${labWork.name}"></td>
            <td th:text="${labWork.discipline.name}"></td>
            <td th:text="${labWork.discipline.practiceHours}"></td>
            <td th:text="${labWork.description}"></td>
            <td th:text="${labWork.difficulty}"></td>
            <td th:text="${labWork.coordinates.x}"></td>
            <td th:text="${labWork.coordinates.y}"></td>
            <td th:text="${labWork.minimalPoint}"></td>
            <td th:text="${labWork.personalQualitiesMaximum}"></td>
            <td th:text="${labWork.personalQualitiesMinimum}"></td>
            <td th:text="${labWork.author.name}"></td>
            <td th:text="${labWork.author.weight}"></td>
            <td th:text="${labWork.author.eyeColor}"></td>
            <td th:text="${labWork.author.hairColor}"></td>
            <td th:text="${labWork.author.location.x}"></td>
            <td th:text="${labWork.author.location.y}"></td>
            <td th:text="${labWork.author.location.name}"></td>
            <td th:text="${labWork.author.passportID}"></td>
            <td>
                <button onclick="editLabWork(${labWork.id})">Edit</button>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<!-- Модальное окно для редактирования Lab Work -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Edit Lab Work</h2>
        <form id="editLabWorkForm" onsubmit="updateLabWork(event, document.getElementById('editLabWorkId').value)">
            <input type="hidden" id="editLabWorkId" name="id">
            <input type="text" id="editLabWorkOwnerId" name="owner_id" placeholder="Owner ID" required>
            <input type="text" id="editLabWorkName" name="name" placeholder="Lab Work Name" required>
            <input type="text" id="editLabWorkDisciplineName" name="disciplineName" placeholder="Discipline Name" required>
            <input type="number" id="editLabWorkPracticeHours" name="practiceHours" placeholder="Practice Hours" required>
            <input type="text" id="editLabWorkDescription" name="description" placeholder="Description" required>
            <input type="text" id="editLabWorkDifficulty" name="difficulty" placeholder="Difficulty" required>
            <input type="number" id="editLabWorkCoordinatesX" name="coordinatesX" placeholder="Coordinates X" required>
            <input type="number" id="editLabWorkCoordinatesY" name="coordinatesY" placeholder="Coordinates Y" required>
            <input type="number" id="editLabWorkMinimalPoint" name="minimalPoint" placeholder="Minimal Point" required>
            <input type="number" id="editLabWorkPersonalQualitiesMax" name="personalQualitiesMaximum" placeholder="Personal Qualities Max" required>
            <input type="number" id="editLabWorkPersonalQualitiesMin" name="personalQualitiesMinimum" placeholder="Personal Qualities Min" required>
            <input type="text" id="editLabWorkAuthorName" name="authorName" placeholder="Author Name" required>
            <input type="number" id="editLabWorkAuthorWeight" name="authorWeight" placeholder="Author Weight" required>
            <input type="text" id="editLabWorkAuthorEyeColor" name="authorEyeColor" placeholder="Author Eye Color" required>
            <input type="text" id="editLabWorkAuthorHairColor" name="authorHairColor" placeholder="Author Hair Color" required>
            <input type="number" id="editLabWorkLocationX" name="locationX" placeholder="Location X" required>
            <input type="number" id="editLabWorkLocationY" name="locationY" placeholder="Location Y" required>
            <input type="text" id="editLabWorkLocationName" name="locationName" placeholder="Location Name" required>
            <input type="text" id="editLabWorkPassportID" name="passportID" placeholder="Passport ID" required>
            <button type="submit">Update Lab Work</button>
        </form>
    </div>
</div>

<a href="/logout">Logout</a>
</body>
</html>
